name: 'Prompt Evaluation'

on:
  pull_request:
    paths:
      - 'prompts/*.txt'
      - 'promptfooconfig.yaml'
      - '.github/workflows/*.yml'
  push:
    branches:
      - main
    paths:
      - 'prompts/*.txt'
      - 'promptfooconfig.yaml'
      - '.github/workflows/*.yml'
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    environment: promptfoo
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install promptfoo
        run: npm install -g promptfoo

      - name: Run promptfoo evaluation (PR)
        if: github.event_name == 'pull_request'
        uses: promptfoo/promptfoo-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          config: 'promptfooconfig.yaml'
 
      - name: Run evaluation and generate report
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create output directory
          mkdir -p promptfoo-results
          
          # Run evaluation
          promptfoo eval -c promptfooconfig.yaml
          
          # Generate HTML report from evaluation results
          promptfoo view --output promptfoo-results/report.html
          
          # Also export JSON results for programmatic access
          promptfoo export promptfoo-results/results.json
 
      - name: Upload evaluation results
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: promptfoo-results-${{ github.sha }}
          path: promptfoo-results/
          retention-days: 30
          if-no-files-found: warn

      - name: Add results to workflow summary
        if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
        run: |
          echo "## ðŸ“Š Prompt Evaluation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Evaluation completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Report: \`promptfoo-results/report.html\`" >> $GITHUB_STEP_SUMMARY
          echo "- JSON Results: \`promptfoo-results/results.json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the workflow run to view detailed results." >> $GITHUB_STEP_SUMMARY